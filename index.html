<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Arquivos XLSX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/icone.png" type="image/png">
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Previne a rolagem do corpo da página */
        }
        .highlight {
            background-color: #facc15; /* yellow-400 */
            color: #111827; /* gray-900 */
            font-weight: bold;
            border-radius: 3px;
            padding: 1px 2px;
        }
        /* Estilo para a linha atualmente selecionada pelo botão flutuante */
        tbody tr.current-row {
            background-color: rgba(59, 130, 246, 0.2); /* bg-blue-500 com opacidade */
            --tw-ring-color: #3b82f6;
            --tw-ring-offset-shadow: 0 0 #0000;
            --tw-ring-shadow: 0 0 #0000;
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            outline: 2px solid var(--tw-ring-color);
            outline-offset: -2px;
        }
        tbody tr {
            scroll-margin-top: 45px;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
            border-radius: 20px;
            border: 3px solid #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280; /* gray-500 */
        }
        /* Estilos para feedback de drag-and-drop */
        .drop-zone.drag-over-active {
            border-color: #4ade80 !important; /* green-400, mais chamativo */
            background-color: rgba(74, 222, 128, 0.2) !important; /* green-400 com opacidade */
        }
        .body-drag-over::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1); /* Leve enuviamento */
            z-index: 999; /* Garante que fique acima do conteúdo, mas abaixo de modais */
            pointer-events: none; /* Permite que interações passem por ele */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="h-[calc(100vh-20px)] m-2.5 w-auto flex flex-col bg-gray-800 rounded-lg shadow-2xl">
        <div id="control-bar" class="flex-shrink-0 p-2 bg-gray-800 border-b border-gray-700 space-y-2">
            <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                <button id="info-btn" class="flex-shrink-0 h-7 w-7 flex items-center justify-center bg-blue-600 hover:bg-blue-700 rounded-full text-white font-bold text-sm transition-colors" title="Instruções">?</button>

                <div id="drop-zone-1" class="drop-zone flex items-center gap-x-3 border-2 border-dashed border-gray-600 rounded-md p-2 transition-colors duration-200">
                    <label for="file-input-1" class="text-sm px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-md cursor-pointer transition-colors">Arquivo Base</label>
                    <input type="file" id="file-input-1" class="hidden" accept=".xlsx">
                    <span id="file-name-1" class="text-xs text-green-400 max-w-xs truncate">Nenhum selecionado</span>
                </div>

                <div id="drop-zone-2" class="drop-zone flex items-center gap-x-3 border-2 border-dashed border-gray-600 rounded-md p-2 transition-colors duration-200">
                    <label for="file-input-2" class="text-sm px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-md cursor-pointer transition-colors">Arquivo Novo</label>
                    <input type="file" id="file-input-2" class="hidden" accept=".xlsx">
                    <span id="file-name-2" class="text-xs text-green-400 max-w-xs truncate">Nenhum selecionado</span>
                </div>

                <button id="compare-btn" class="text-sm px-4 py-1.5 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold rounded-md transition-colors">Comparar</button>

                <div class="flex-grow">
                    <input type="text" id="filter-input" placeholder='Filtrar... (use "" para frases, ex: "termo 1" termo2)' class="w-full text-sm p-1.5 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
            </div>
             <div class="grid grid-cols-3 items-center min-h-[20px]">
                <div id="status-container" class="text-xs text-yellow-300"></div>
                <div id="filter-status" class="text-xs text-gray-400 text-center"></div>
                <div></div> </div>
        </div>

        <div id="predefined-filters-container" class="flex-shrink-0 p-2 border-b border-gray-700 flex flex-wrap items-center gap-x-3 gap-y-2 hidden">
        </div>

        <div id="results-container" class="flex-grow flex flex-col overflow-hidden">
             <div id="table-wrapper" class="flex-grow overflow-auto bg-gray-900">
                <table class="min-w-full text-sm text-left text-gray-300 table-fixed">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3">Processo</th>
                            <th scope="col" class="px-6 py-3">SUPP</th>
                            <th scope="col" class="px-6 py-3">Diário</th>
                            <th scope="col" class="px-6 py-3">Órgão</th>
                            <th scope="col" class="px-6 py-3">Teor da NE</th>
                            <th scope="col" class="px-6 py-3">Critérios PGE</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody" class="bg-gray-200 text-black">
                    </tbody>
                </table>
            </div>
             <div id="no-results-message" class="flex-grow flex items-center justify-center text-gray-500 hidden">
                <p>Nenhum resultado encontrado para o filtro atual.</p>
            </div>
             <div id="initial-message" class="flex-grow flex items-center justify-center text-gray-500">
                <p>Aguardando arquivos para comparação...</p>
            </div>
        </div>
    </div>

    <div id="info-modal-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="info-modal" class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-2xl mx-4 border border-gray-700">
            <h2 class="text-2xl font-bold text-white mb-4">Instruções de Uso</h2>
            <div class="text-gray-300 space-y-3">
                <p><strong class="text-blue-400">1. Selecionar Arquivos:</strong> Clique nos botões "Arquivo Base" e "Arquivo Novo" para carregar suas planilhas .xlsx. <strong class="text-green-400">Alternativamente, arraste e solte os arquivos nas áreas designadas.</strong></p>
                <p><strong class="text-blue-400">2. Comparar:</strong> Após selecionar os dois arquivos, clique no botão "Comparar". A aplicação irá processar os dados e exibir na tabela abaixo todas as linhas que estão no Arquivo Novo, mas NÃO no Arquivo Base, com base na 5ª coluna (Teor da NE).</p>
                <p><strong class="text-blue-400">3. Filtrar Resultados:</strong> Utilize o campo de filtro para refinar a busca nos resultados. Você pode usar o campo de texto ou clicar em um dos botões de "Filtros Rápidos".</p>
                <p><strong class="text-blue-400">4. Navegar na Tabela:</strong> A tabela pode ser rolada verticalmente e horizontalmente. Quando houver resultados, um botão flutuante com o texto "Próx." aparecerá no canto inferior direito para navegar linha a linha.</p>
            </div>
            <div class="mt-6 text-right">
                <button id="close-modal-btn" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <button id="next-row-btn" title="Próxima Linha" class="hidden fixed bottom-6 right-6 h-12 px-5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full flex items-center justify-center shadow-lg transition-transform duration-200 hover:scale-110">
        Próx.
    </button>

    <script>
    // Elementos da DOM
    const fileInput1 = document.getElementById('file-input-1');
    const fileInput2 = document.getElementById('file-input-2');
    const fileName1 = document.getElementById('file-name-1');
    const fileName2 = document.getElementById('file-name-2');
    const compareBtn = document.getElementById('compare-btn');
    const statusContainer = document.getElementById('status-container');
    const resultsContainer = document.getElementById('results-container');
    const filterInput = document.getElementById('filter-input');
    const filterStatus = document.getElementById('filter-status');
    const resultsTbody = document.getElementById('results-tbody');
    const noResultsMessage = document.getElementById('no-results-message');
    const initialMessage = document.getElementById('initial-message');
    const tableWrapper = document.getElementById('table-wrapper');
    const infoBtn = document.getElementById('info-btn');
    const infoModalOverlay = document.getElementById('info-modal-overlay');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const nextRowBtn = document.getElementById('next-row-btn');
    const predefinedFiltersContainer = document.getElementById('predefined-filters-container');
    const dropZone1 = document.getElementById('drop-zone-1');
    const dropZone2 = document.getElementById('drop-zone-2');
    const body = document.body;

    let differences = [];
    let displayColumns = [];
    let currentRowIndex = -1;

    const PREDEFINED_FILTERS = ['#proc', '[exprovas] [n] #pge', '[corag]', 'graficas]', '[audiencia] [s]', '[pauta] [s]', '[pauta] [n] #pge_repint', '[audiencia] [n] #pge_repint', '[audiencia] [n] #PGE_Extinta', '[pauta] [n] #PGE_Extinta'];

    // --- LÓGICA DE DRAG AND DROP ATUALIZADA ---
    function setupDropZone(dropZone, fileInput) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over-active');
                body.classList.add('body-drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over-active');
                if (!document.querySelector('.drop-zone.drag-over-active')) {
                    body.classList.remove('body-drag-over');
                }
            }, false);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                if (files[0].name.endsWith('.xlsx')) {
                    fileInput.files = files;
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                } else {
                    alert('Por favor, solte apenas arquivos no formato .xlsx');
                }
            }
        }, false);
    }
    // --- FIM DA LÓGICA DE DRAG AND DROP ---

    function setupPredefinedFilters() {
        predefinedFiltersContainer.innerHTML = '';
        PREDEFINED_FILTERS.forEach(filterTerm => {
            const button = document.createElement('button');
            button.className = 'text-xs px-2.5 py-1 bg-gray-700 hover:bg-gray-600 rounded-md cursor-pointer transition-colors';
            button.dataset.filter = filterTerm;
            button.innerHTML = `${filterTerm} <span class="font-bold text-gray-500">0</span>`;
            predefinedFiltersContainer.appendChild(button);
        });
    }

    function updatePredefinedFilterCounts() {
        if (differences.length === 0) {
            predefinedFiltersContainer.classList.add('hidden');
            return;
        }
        predefinedFiltersContainer.classList.remove('hidden');

        PREDEFINED_FILTERS.forEach(filterTerm => {
            const searchTerm = filterTerm.toLowerCase();
            if (!searchTerm) return;

            const count = differences.filter(row =>
                Object.values(row).some(cellValue =>
                    String(cellValue || '').toLowerCase().includes(searchTerm)
                )
            ).length;

            const button = predefinedFiltersContainer.querySelector(`[data-filter="${filterTerm}"]`);
            if(button) {
                const countColorClass = count === 0 ? 'text-gray-500' : 'text-green-400';
                button.innerHTML = `${filterTerm} <span class="font-bold ${countColorClass}">${count}</span>`;
            }
        });
    }

    predefinedFiltersContainer.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button && button.dataset.filter) {
            filterInput.value = button.dataset.filter;
            filterInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
    });

    nextRowBtn.addEventListener('click', () => {
        const visibleRows = resultsTbody.querySelectorAll('tr');
        if (visibleRows.length === 0) return;

        const oldRow = resultsTbody.querySelector('.current-row');
        if (oldRow) {
            oldRow.classList.remove('current-row');
        }

        currentRowIndex++;
        if (currentRowIndex >= visibleRows.length) {
            currentRowIndex = 0;
        }

        const newRow = visibleRows[currentRowIndex];
        if (newRow) {
            newRow.classList.add('current-row');
            newRow.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });

    function updateCompareButtonState() {
        compareBtn.disabled = !(fileInput1.files.length > 0 && fileInput2.files.length > 0);
    }

    fileInput1.addEventListener('change', () => {
        fileName1.textContent = fileInput1.files[0]?.name || 'Nenhum selecionado';
        updateCompareButtonState();
    });

    fileInput2.addEventListener('change', () => {
        fileName2.textContent = fileInput2.files[0]?.name || 'Nenhum selecionado';
        updateCompareButtonState();
    });

    function readXlsxFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    resolve(jsonData);
                } catch (error) {
                    reject(new Error(`Falha ao processar o arquivo ${file.name}. Verifique se o formato é válido.`));
                }
            };
            reader.onerror = (error) => reject(new Error(`Falha ao ler o arquivo ${file.name}.`));
            reader.readAsArrayBuffer(file);
        });
    }

    function createRowIdentifier(row) {
        const values = Object.values(row);
        const value = values.length > 4 ? values[4] : '';
        return String(value || '').replace(/\s+/g, ' ').trim().toLowerCase();
    }

    function showStatus(message, type = 'info') {
        statusContainer.textContent = message;
        statusContainer.className = 'text-xs';
        if (type === 'error') {
            statusContainer.classList.add('text-red-400');
        } else if (type === 'success') {
            statusContainer.classList.add('text-green-400');
        } else if (type === 'loading') {
            statusContainer.classList.add('text-blue-400');
        } else {
             statusContainer.classList.add('text-yellow-300');
        }
    }

    compareBtn.addEventListener('click', async () => {
        if (compareBtn.disabled) return;

        showStatus('Processando arquivos...', 'loading');
        initialMessage.classList.add('hidden');
        tableWrapper.classList.add('hidden');
        predefinedFiltersContainer.classList.add('hidden');
        resultsTbody.innerHTML = '';
        filterStatus.textContent = '';
        differences = [];
        displayColumns = [];

        try {
            const [data1, data2] = await Promise.all([
                readXlsxFile(fileInput1.files[0]),
                readXlsxFile(fileInput2.files[0])
            ]);

            if (displayColumns.length === 0) {
                let headers;
                if (data2.length > 0) {
                    headers = Object.keys(data2[0]);
                } else if (data1.length > 0) {
                    headers = Object.keys(data1[0]);
                }

                if (headers) {
                    displayColumns.push(...headers.slice(0, 6));
                } else {
                    showStatus('Nenhum dos arquivos contém dados para exibir.', 'info');
                    return;
                }
            }

            showStatus('Comparando dados...', 'loading');
            const identifiersFile1 = new Set(data1.map(createRowIdentifier));
            differences = data2.filter(row => !identifiersFile1.has(createRowIdentifier(row)));

            statusContainer.textContent = '';

            if (differences.length > 0) {
                renderTable(differences);
                updatePredefinedFilterCounts();
            } else {
                showStatus('Nenhuma diferença encontrada.', 'info');
                initialMessage.classList.remove('hidden');
                initialMessage.querySelector('p').textContent = 'Nenhuma diferença encontrada.';
                updatePredefinedFilterCounts();
                nextRowBtn.classList.add('hidden');
            }

        } catch (error) {
            showStatus(error.message, 'error');
        }
    });

    function renderTable(data, searchTerms = []) {
        resultsTbody.innerHTML = '';
        initialMessage.classList.add('hidden');
        currentRowIndex = -1;

        if (data.length > 0) {
            nextRowBtn.classList.remove('hidden');
        } else {
            nextRowBtn.classList.add('hidden');
        }

        const totalCount = differences.length;
        const filteredCount = data.length;
        if (totalCount > 0) {
            filterStatus.className = 'text-xs font-semibold text-green-400 text-center';
            filterStatus.textContent = `Exibindo ${filteredCount} de ${totalCount} resultado(s).`;
        } else {
            filterStatus.textContent = '';
        }

        if (data.length === 0 && totalCount > 0) {
            noResultsMessage.classList.remove('hidden');
            tableWrapper.classList.add('hidden');
        } else {
            noResultsMessage.classList.add('hidden');
            tableWrapper.classList.remove('hidden');
        }

        const fragment = document.createDocumentFragment();
        const mainSearchRegex = searchTerms.length > 0
            ? new RegExp(`(${searchTerms.map(escapeRegExp).join('|')})`, 'gi')
            : null;

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-700 hover:bg-gray-700/15 transition-colors duration-150';

            const pgeCriteraValue = Object.values(row).length > 5 ? Object.values(row)[5] : '';
            const pgeTermsToHighlight = [];
            if (pgeCriteraValue) {
                const matches = String(pgeCriteraValue).match(/\[(.*?)\]/g);
                if (matches) {
                    matches.forEach(match => {
                        const term = match.substring(1, match.length - 1);
                        if (term) {
                            pgeTermsToHighlight.push(escapeRegExp(term));
                        }
                    });
                }
            }
            const pgeRegex = pgeTermsToHighlight.length > 0
                ? new RegExp(`(${pgeTermsToHighlight.join('|')})`, 'gi')
                : null;


            displayColumns.forEach((colName, index) => {
                const td = document.createElement('td');
                const baseClasses = 'px-6 py-4 align-top';
                let specificClasses = '';
                let cellValue = row[colName] || '';
                let processedCellValue = String(cellValue);

                switch (index) {
                    case 0: specificClasses = 'whitespace-normal break-words w-[300px]'; processedCellValue = processedCellValue.replace(/\]/g, ']<br>'); break;
                    case 3: specificClasses = 'whitespace-normal break-words w-[200px]'; break;
                    case 4: specificClasses = 'whitespace-normal w-[620px]'; if (pgeRegex) { processedCellValue = processedCellValue.replace(pgeRegex, `<span class="bg-orange-400 rounded px-1">$1</span>`); } break;
                    case 5: specificClasses = 'whitespace-normal break-words w-[200px]'; processedCellValue = processedCellValue.replace(/#/g, '<br>#').replace(/^<br>/, ''); break;
                    default: specificClasses = 'whitespace-nowrap'; break;
                }
                td.className = `${baseClasses} ${specificClasses}`;

                if (mainSearchRegex) {
                    td.innerHTML = processedCellValue.replace(mainSearchRegex, `<span class="highlight">$1</span>`);
                } else {
                    td.innerHTML = processedCellValue;
                }
                tr.appendChild(td);
            });
            fragment.appendChild(tr);
        });
        resultsTbody.appendChild(fragment);
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function debounce(func, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    }

    const handleFilterInput = (e) => {
        const rawSearchText = e.target.value.trim();
        if (!differences.length) return;

        const oldRow = resultsTbody.querySelector('.current-row');
        if (oldRow) {
            oldRow.classList.remove('current-row');
        }

        const searchTerms = rawSearchText.match(/(?:[^\s"]+|"[^"]*")+/g) || [];

        const cleanedTerms = searchTerms.map(term =>
            term.replace(/^"|"$/g, '').toLowerCase()
        ).filter(term => term);

        if (cleanedTerms.length === 0) {
            renderTable(differences);
            return;
        }

        const filteredData = differences.filter(row => {
            return cleanedTerms.every(term => {
                return Object.values(row).some(cellValue =>
                    String(cellValue || '').toLowerCase().includes(term)
                );
            });
        });

        renderTable(filteredData, cleanedTerms);
    };

    filterInput.addEventListener('input', debounce(handleFilterInput, 300));

    infoBtn.addEventListener('click', () => {
        infoModalOverlay.classList.remove('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
        infoModalOverlay.classList.add('hidden');
    });

    infoModalOverlay.addEventListener('click', (e) => {
        if (e.target === infoModalOverlay) {
            infoModalOverlay.classList.add('hidden');
        }
    });

    // Inicialização da página
    setupPredefinedFilters();
    updateCompareButtonState();
    tableWrapper.classList.add('hidden');
    // Inicializa as zonas de drop
    setupDropZone(dropZone1, fileInput1);
    setupDropZone(dropZone2, fileInput2);
</script>
</body>
</html>
